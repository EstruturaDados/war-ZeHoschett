#include <stdio.h>
#include <stdlib.h>
#include <string.h>

// =======================================================
// ESTRUTURA DA MANSÃO (ÁRVORE BINÁRIA DE SALAS)
// =======================================================
typedef struct Sala {
    char nome[50];
    char pista[100];
    struct Sala *esquerda;
    struct Sala *direita;
} Sala;

// =======================================================
// ESTRUTURA DA ÁRVORE DE PISTAS (BST - Binary Search Tree)
// =======================================================
typedef struct PistaNode {
    char pista[100];
    struct PistaNode *esquerda;
    struct PistaNode *direita;
} PistaNode;

// =======================================================
// Função: criarSala()
// Cria dinamicamente uma sala com nome e uma pista associada (ou vazia)
// =======================================================
Sala* criarSala(const char *nome, const char *pista) {
    Sala *nova = (Sala*) malloc(sizeof(Sala));
    if (nova == NULL) {
        printf("Erro ao alocar memória para a sala!\n");
        exit(1);
    }
    strcpy(nova->nome, nome);
    strcpy(nova->pista, pista);
    nova->esquerda = NULL;
    nova->direita = NULL;
    return nova;
}

// =======================================================
// Função: criarPista()
// Cria dinamicamente um nó na árvore BST de pistas
// =======================================================
PistaNode* criarPista(const char *pista) {
    PistaNode *nova = (PistaNode*) malloc(sizeof(PistaNode));
    if (nova == NULL) {
        printf("Erro ao alocar memória para pista!\n");
        exit(1);
    }
    strcpy(nova->pista, pista);
    nova->esquerda = NULL;
    nova->direita = NULL;
    return nova;
}

// =======================================================
// Função: inserirPista()
// Insere uma nova pista na árvore BST em ordem alfabética
// =======================================================
PistaNode* inserirPista(PistaNode *raiz, const char *pista) {
    if (raiz == NULL) {
        return criarPista(pista);
    }

    if (strcmp(pista, raiz->pista) < 0)
        raiz->esquerda = inserirPista(raiz->esquerda, pista);
    else if (strcmp(pista, raiz->pista) > 0)
        raiz->direita = inserirPista(raiz->direita, pista);

    return raiz;
}

// =======================================================
// Função: exibirPistas()
// Percorre e exibe a árvore de pistas em ordem alfabética (in-order)
// =======================================================
void exibirPistas(PistaNode *raiz) {
    if (raiz == NULL) return;
    exibirPistas(raiz->esquerda);
    printf(" - %s\n", raiz->pista);
    exibirPistas(raiz->direita);
}

// =======================================================
// Função: explorarSalasComPistas()
// Controla a navegação do jogador e coleta automática das pistas
// =======================================================
void explorarSalasComPistas(Sala *atual, PistaNode **pistas) {
    char opcao;

    printf("\n Você está no %s.\n", atual->nome);

    // Coleta automática da pista (se houver)
    if (strlen(atual->pista) > 0) {
        printf(" Você encontrou uma pista: \"%s\"\n", atual->pista);
        *pistas = inserirPista(*pistas, atual->pista);
    } else {
        printf("Nenhuma pista encontrada aqui.\n");
    }

    // Loop de exploração
    while (1) {
        printf("\nEscolha um caminho:\n");
        if (atual->esquerda != NULL)
            printf(" [e] Ir para %s (esquerda)\n", atual->esquerda->nome);
        if (atual->direita != NULL)
            printf(" [d] Ir para %s (direita)\n", atual->direita->nome);
        printf(" [s] Sair da mansão\n");
        printf("Opção: ");
        scanf(" %c", &opcao);

        if (opcao == 'e' && atual->esquerda != NULL) {
            explorarSalasComPistas(atual->esquerda, pistas);
            return; // volta para o nível anterior após explorar
        } 
        else if (opcao == 'd' && atual->direita != NULL) {
            explorarSalasComPistas(atual->direita, pistas);
            return;
        } 
        else if (opcao == 's' || opcao == 'S') {
            printf("\n Você decidiu encerrar a exploração.\n");
            return;
        } 
        else {
            printf("Opção inválida! Tente novamente.\n");
        }
    }
}

// =======================================================
// Função: liberarArvoreSalas()
// Libera memória de todas as salas (recursiva)
// =======================================================
void liberarArvoreSalas(Sala *raiz) {
    if (raiz == NULL) return;
    liberarArvoreSalas(raiz->esquerda);
    liberarArvoreSalas(raiz->direita);
    free(raiz);
}

// =======================================================
// Função: liberarArvorePistas()
// Libera memória da árvore de pistas
// =======================================================
void liberarArvorePistas(PistaNode *raiz) {
    if (raiz == NULL) return;
    liberarArvorePistas(raiz->esquerda);
    liberarArvorePistas(raiz->direita);
    free(raiz);
}

// =======================================================
// Função principal: main()
// Monta o mapa da mansão, inicia a exploração e mostra as pistas
// =======================================================
int main() {
    // Criação das salas (mapa da mansão)
    Sala *hall = criarSala("Hall de Entrada", "Uma pegada de lama no tapete.");
    Sala *salaEstar = criarSala("Sala de Estar", "Um relógio parado às 3h15.");
    Sala *cozinha = criarSala("Cozinha", "Uma xícara quebrada e café fresco.");
    Sala *biblioteca = criarSala("Biblioteca", "Um livro aberto sobre venenos raros.");
    Sala *jardim = criarSala("Jardim", "Pegadas levando até o portão dos fundos.");
    Sala *porao = criarSala("Porão", "Um casaco ensanguentado escondido atrás de caixas.");

    // Estrutura fixa (árvore da mansão)
    hall->esquerda = salaEstar;
    hall->direita = cozinha;
    salaEstar->esquerda = biblioteca;
    salaEstar->direita = jardim;
    cozinha->direita = porao;

    // Ponteiro para a árvore BST de pistas
    PistaNode *pistas = NULL;

    printf("==============================================\n");
    printf(" DETECTIVE QUEST: A MANSÃO DAS PISTAS\n");
    printf("==============================================\n");
    printf("Explore a mansão e colete pistas para resolver o mistério!\n");

    // Inicia a exploração a partir do Hall
    explorarSalasComPistas(hall, &pistas);

    // Exibe as pistas encontradas
    printf("\n==============================================\n");
    printf(" PISTAS COLETADAS (em ordem alfabética):\n");
    printf("==============================================\n");

    if (pistas == NULL) {
        printf("Nenhuma pista foi encontrada.\n");
    } else {
        exibirPistas(pistas);
    }

    printf("\nObrigado por jogar Detective Quest!\n");
    printf("Boa sorte na investigação, detetive. \n");

    // Libera memória
    liberarArvoreSalas(hall);
    liberarArvorePistas(pistas);

    return 0;
}
