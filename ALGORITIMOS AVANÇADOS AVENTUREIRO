#include <stdio.h>
#include <stdlib.h>
#include <string.h>

// =======================================================
// ESTRUTURA DA MANS√ÉO (√ÅRVORE BIN√ÅRIA DE SALAS)
// =======================================================
typedef struct Sala {
    char nome[50];
    char pista[100];
    struct Sala *esquerda;
    struct Sala *direita;
} Sala;

// =======================================================
// ESTRUTURA DA √ÅRVORE DE PISTAS (BST - Binary Search Tree)
// =======================================================
typedef struct PistaNode {
    char pista[100];
    struct PistaNode *esquerda;
    struct PistaNode *direita;
} PistaNode;

// =======================================================
// Fun√ß√£o: criarSala()
// Cria dinamicamente uma sala com nome e uma pista associada (ou vazia)
// =======================================================
Sala* criarSala(const char *nome, const char *pista) {
    Sala *nova = (Sala*) malloc(sizeof(Sala));
    if (nova == NULL) {
        printf("Erro ao alocar mem√≥ria para a sala!\n");
        exit(1);
    }
    strcpy(nova->nome, nome);
    strcpy(nova->pista, pista);
    nova->esquerda = NULL;
    nova->direita = NULL;
    return nova;
}

// =======================================================
// Fun√ß√£o: criarPista()
// Cria dinamicamente um n√≥ na √°rvore BST de pistas
// =======================================================
PistaNode* criarPista(const char *pista) {
    PistaNode *nova = (PistaNode*) malloc(sizeof(PistaNode));
    if (nova == NULL) {
        printf("Erro ao alocar mem√≥ria para pista!\n");
        exit(1);
    }
    strcpy(nova->pista, pista);
    nova->esquerda = NULL;
    nova->direita = NULL;
    return nova;
}

// =======================================================
// Fun√ß√£o: inserirPista()
// Insere uma nova pista na √°rvore BST em ordem alfab√©tica
// =======================================================
PistaNode* inserirPista(PistaNode *raiz, const char *pista) {
    if (raiz == NULL) {
        return criarPista(pista);
    }

    if (strcmp(pista, raiz->pista) < 0)
        raiz->esquerda = inserirPista(raiz->esquerda, pista);
    else if (strcmp(pista, raiz->pista) > 0)
        raiz->direita = inserirPista(raiz->direita, pista);

    return raiz;
}

// =======================================================
// Fun√ß√£o: exibirPistas()
// Percorre e exibe a √°rvore de pistas em ordem alfab√©tica (in-order)
// =======================================================
void exibirPistas(PistaNode *raiz) {
    if (raiz == NULL) return;
    exibirPistas(raiz->esquerda);
    printf(" - %s\n", raiz->pista);
    exibirPistas(raiz->direita);
}

// =======================================================
// Fun√ß√£o: explorarSalasComPistas()
// Controla a navega√ß√£o do jogador e coleta autom√°tica das pistas
// =======================================================
void explorarSalasComPistas(Sala *atual, PistaNode **pistas) {
    char opcao;

    printf("\nüïµÔ∏è Voc√™ est√° no %s.\n", atual->nome);

    // Coleta autom√°tica da pista (se houver)
    if (strlen(atual->pista) > 0) {
        printf("üìú Voc√™ encontrou uma pista: \"%s\"\n", atual->pista);
        *pistas = inserirPista(*pistas, atual->pista);
    } else {
        printf("Nenhuma pista encontrada aqui.\n");
    }

    // Loop de explora√ß√£o
    while (1) {
        printf("\nEscolha um caminho:\n");
        if (atual->esquerda != NULL)
            printf(" [e] Ir para %s (esquerda)\n", atual->esquerda->nome);
        if (atual->direita != NULL)
            printf(" [d] Ir para %s (direita)\n", atual->direita->nome);
        printf(" [s] Sair da mans√£o\n");
        printf("Op√ß√£o: ");
        scanf(" %c", &opcao);

        if (opcao == 'e' && atual->esquerda != NULL) {
            explorarSalasComPistas(atual->esquerda, pistas);
            return; // volta para o n√≠vel anterior ap√≥s explorar
        } 
        else if (opcao == 'd' && atual->direita != NULL) {
            explorarSalasComPistas(atual->direita, pistas);
            return;
        } 
        else if (opcao == 's' || opcao == 'S') {
            printf("\nüîé Voc√™ decidiu encerrar a explora√ß√£o.\n");
            return;
        } 
        else {
            printf("Op√ß√£o inv√°lida! Tente novamente.\n");
        }
    }
}

// =======================================================
// Fun√ß√£o: liberarArvoreSalas()
// Libera mem√≥ria de todas as salas (recursiva)
// =======================================================
void liberarArvoreSalas(Sala *raiz) {
    if (raiz == NULL) return;
    liberarArvoreSalas(raiz->esquerda);
    liberarArvoreSalas(raiz->direita);
    free(raiz);
}

// =======================================================
// Fun√ß√£o: liberarArvorePistas()
// Libera mem√≥ria da √°rvore de pistas
// =======================================================
void liberarArvorePistas(PistaNode *raiz) {
    if (raiz == NULL) return;
    liberarArvorePistas(raiz->esquerda);
    liberarArvorePistas(raiz->direita);
    free(raiz);
}

// =======================================================
// Fun√ß√£o principal: main()
// Monta o mapa da mans√£o, inicia a explora√ß√£o e mostra as pistas
// =======================================================
int main() {
    // Cria√ß√£o das salas (mapa da mans√£o)
    Sala *hall = criarSala("Hall de Entrada", "Uma pegada de lama no tapete.");
    Sala *salaEstar = criarSala("Sala de Estar", "Um rel√≥gio parado √†s 3h15.");
    Sala *cozinha = criarSala("Cozinha", "Uma x√≠cara quebrada e caf√© fresco.");
    Sala *biblioteca = criarSala("Biblioteca", "Um livro aberto sobre venenos raros.");
    Sala *jardim = criarSala("Jardim", "Pegadas levando at√© o port√£o dos fundos.");
    Sala *porao = criarSala("Por√£o", "Um casaco ensanguentado escondido atr√°s de caixas.");

    // Estrutura fixa (√°rvore da mans√£o)
    hall->esquerda = salaEstar;
    hall->direita = cozinha;
    salaEstar->esquerda = biblioteca;
    salaEstar->direita = jardim;
    cozinha->direita = porao;

    // Ponteiro para a √°rvore BST de pistas
    PistaNode *pistas = NULL;

    printf("==============================================\n");
    printf("üé© DETECTIVE QUEST: A MANS√ÉO DAS PISTAS\n");
    printf("==============================================\n");
    printf("Explore a mans√£o e colete pistas para resolver o mist√©rio!\n");

    // Inicia a explora√ß√£o a partir do Hall
    explorarSalasComPistas(hall, &pistas);

    // Exibe as pistas encontradas
    printf("\n==============================================\n");
    printf("üìú PISTAS COLETADAS (em ordem alfab√©tica):\n");
    printf("==============================================\n");

    if (pistas == NULL) {
        printf("Nenhuma pista foi encontrada.\n");
    } else {
        exibirPistas(pistas);
    }

    printf("\nObrigado por jogar Detective Quest!\n");
    printf("Boa sorte na investiga√ß√£o, detetive. üïµÔ∏è‚Äç‚ôÇÔ∏è\n");

    // Libera mem√≥ria
    liberarArvoreSalas(hall);
    liberarArvorePistas(pistas);

    return 0;
}
